<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Admin Panel</title>

<style>
*{box-sizing:border-box;font-family:system-ui}
body{
 margin:0;
 min-height:100vh;
 background:linear-gradient(180deg,#4f46e5,#6d6af5);
 padding:18px;
}
.container{max-width:440px;margin:auto}
.card{
 background:#fff;
 border-radius:22px;
 padding:20px;
 margin-bottom:18px;
 box-shadow:0 15px 35px rgba(0,0,0,.25);
}
h2{text-align:center;color:#4f46e5;margin:0 0 14px}
input,textarea,button{
 width:100%;
 padding:14px;
 margin-top:12px;
 border-radius:16px;
 border:1.5px solid #ddd;
 font-size:15px;
}
button{
 border:none;
 font-weight:800;
 color:#fff;
 background:#4f46e5;
 cursor:pointer;
}
.logout{background:#ef4444}
.verify{background:#22c55e}
.reject{background:#ef4444}
.toggle{background:#0ea5e9}
.order{
 background:#f8fafc;
 border-radius:16px;
 padding:14px;
 margin-top:12px;
 font-size:14px;
}
.stockItem{font-size:13px;padding:6px 0}
</style>
</head>

<body>
<div class="container">

<!-- LOGIN -->
<div class="card" id="loginCard">
<h2>üîê Admin Login</h2>
<input id="email" placeholder="Admin Email">
<input id="pass" type="password" placeholder="Password">
<button onclick="login()">Login</button>
</div>

<!-- PANEL -->
<div class="card" id="panel" style="display:none">
<h2>‚öôÔ∏è Admin Panel</h2>

<button class="toggle" onclick="toggleShop()" id="shopBtn">
Loading shop status...
</button>

<input id="price" type="number" placeholder="Price per ID">
<button onclick="savePrice()">Update Price</button>

<hr>

<textarea id="ids" rows="6" placeholder="username
password
phone
email"></textarea>
<button onclick="addIDs()">Add IDs</button>

<hr>

<h3>üì¶ Stock Status</h3>
<div id="stockList"></div>
<h3>Total Available: <span id="stock">0</span></h3>

<hr>

<h3>‚è≥ Pending Orders</h3>
<div id="orders"></div>

<button class="logout" onclick="logout()">Logout</button>
<audio id="alertAudio" src="beep.mp3" loop></audio>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-app.js";
import { getAuth, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-auth.js";
import { getDatabase, ref, set, push, onValue, update, get, remove }
from "https://www.gstatic.com/firebasejs/12.8.0/firebase-database.js";

const app = initializeApp({
 apiKey:"AIzaSyChBGm2SO7uuW9gIhpFH-MDFzWs0gp9eps",
 databaseURL:"https://database-7209-default-rtdb.firebaseio.com"
});
const auth=getAuth(app);
const db=getDatabase(app);

let audioAllowed=false,isBeeping=false;

/* LOGIN */
window.login=()=>{
 signInWithEmailAndPassword(auth,email.value.trim(),pass.value)
 .then(()=>{
  loginCard.style.display="none";
  panel.style.display="block";
  alertAudio.play().then(()=>{alertAudio.pause();audioAllowed=true}).catch(()=>{});
 })
 .catch(e=>alert(e.message));
};

window.logout=()=>signOut(auth).then(()=>{
 panel.style.display="none";
 loginCard.style.display="block";
});

/* SHOP OPEN / CLOSE */
onValue(ref(db,"settings/shopOpen"),s=>{
 const open=s.val();
 shopBtn.innerText=open?"üü¢ SHOP OPEN":"üî¥ SHOP CLOSED";
 shopBtn.style.background=open?"#22c55e":"#ef4444";
});

window.toggleShop=async()=>{
 const s=await get(ref(db,"settings/shopOpen"));
 await set(ref(db,"settings/shopOpen"),!s.val());
};

/* PRICE */
window.savePrice=()=>set(ref(db,"settings/pricePerId"),Number(price.value));

/* ADD STOCK */
window.addIDs=()=>{
 const l=ids.value.trim().split("\n");
 if(l.length%4!==0) return alert("Invalid format");
 for(let i=0;i<l.length;i+=4){
  push(ref(db,"stock"),{
   username:l[i],
   password:l[i+1],
   phone:l[i+2],
   email:l[i+3],
   addedAt:Date.now()
  });
 }
 ids.value="";
};

/* STOCK VIEW */
onValue(ref(db,"stock"),snap=>{
 stockList.innerHTML="";
 let c=0,i=1;
 snap.forEach(s=>{
  c++;
  stockList.innerHTML+=`<div class="stockItem">ID #${i++} ‚úÖ</div>`;
 });
 stock.innerText=c;
});

/* ORDERS */
onValue(ref(db,"orders"),snap=>{
 orders.innerHTML="";
 let p=0;
 snap.forEach(o=>{
  const v=o.val();
  if(v.status==="pending"){
   p++;
   orders.innerHTML+=`
    <div class="order">
     <b>Order:</b> ${o.key}
     <b>Qty:</b> ${v.qty}
     <b>UTR:</b> ${v.utr}
     <button class="verify" onclick="verify('${o.key}',${v.qty})">Verify</button>
     <button class="reject" onclick="reject('${o.key}')">Reject</button>
    </div>`;
  }
 });
 if(p>0 && audioAllowed && !isBeeping){alertAudio.play();isBeeping=true}
 if(p===0 && isBeeping){alertAudio.pause();isBeeping=false}
});

/* VERIFY ‚Äì FIFO + DELETE FROM DB */
window.verify=async(id,qty)=>{
 const orderRef=ref(db,"orders/"+id);
 await update(orderRef,{status:"processing"});
 const snap=await get(ref(db,"stock"));
 let picked=[];
 snap.forEach(s=>{
  if(picked.length<qty) picked.push({k:s.key,...s.val()});
 });
 if(picked.length<qty) return alert("No stock");
 for(const it of picked){
  await remove(ref(db,"stock/"+it.k)); // üî• DELETE SOLD ID
  await push(ref(db,"deliveries/"+id),it);
 }
 await update(orderRef,{status:"verified"});
 alert("Delivered");
};

/* REJECT */
window.reject=async(id)=>{
 await remove(ref(db,"orders/"+id));
 await set(ref(db,"rejected/"+id),{msg:"YOUR PAYMENT NOT MATCH"});
};
</script>
</body>
</html>
