
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Admin Panel</title>

<style>
*{box-sizing:border-box;font-family:system-ui}
body{
 margin:0;
 min-height:100vh;
 background:linear-gradient(180deg,#4f46e5,#6d6af5);
 padding:18px;
}
.container{max-width:440px;margin:auto}
.card{
 background:#fff;
 border-radius:22px;
 padding:20px;
 margin-bottom:18px;
 box-shadow:0 15px 35px rgba(0,0,0,.25);
}
h2{text-align:center;color:#4f46e5;margin:0 0 14px}
input,textarea,button{
 width:100%;
 padding:14px;
 margin-top:12px;
 border-radius:16px;
 border:1.5px solid #ddd;
 font-size:15px;
}
button{
 border:none;
 font-weight:800;
 color:#fff;
 background:#4f46e5;
 cursor:pointer;
}
.logout{background:#ef4444}
.order{
 background:#f8fafc;
 border-radius:16px;
 padding:14px;
 margin-top:12px;
 font-size:14px;
}
.order b{display:block;margin-bottom:4px}
.verify{background:#22c55e;margin-top:8px}
</style>
</head>

<body>
<div class="container">

<!-- LOGIN -->
<div class="card" id="loginCard">
<h2>üîê Admin Login</h2>
<input id="email" placeholder="Admin Email">
<input id="pass" type="password" placeholder="Password">
<button onclick="login()">Login</button>
</div>

<!-- PANEL -->
<div class="card" id="panel" style="display:none">
<h2>‚öôÔ∏è Admin Panel</h2>

<input id="price" type="number" placeholder="Price per ID">
<button onclick="savePrice()">Update Price</button>

<hr style="margin:16px 0">

<textarea id="ids" rows="6" placeholder="Add IDs (4 lines per ID)
username
password
phone
email"></textarea>
<button onclick="addIDs()">Add IDs to Stock</button>

<hr style="margin:16px 0">

<h3>üì¶ Available Stock: <span id="stock">0</span></h3>

<hr style="margin:16px 0">

<h3>‚è≥ Pending Orders</h3>
<div id="orders"></div>

<button class="logout" onclick="logout()">Logout</button>

<!-- üîî SOUND -->
<audio id="alertAudio" src="beep.mp3" loop></audio>

</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-app.js";
import { getAuth, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-auth.js";
import { getDatabase, ref, set, push, onValue, update, get }
from "https://www.gstatic.com/firebasejs/12.8.0/firebase-database.js";

/* üî• FIREBASE */
const app = initializeApp({
 apiKey:"AIzaSyChBGm2SO7uuW9gIhpFH-MDFzWs0gp9eps",
 databaseURL:"https://database-7209-default-rtdb.firebaseio.com"
});
const auth = getAuth(app);
const db   = getDatabase(app);

/* üîî SOUND FLAGS */
let audioAllowed=false;
let isBeeping=false;

/* LOGIN */
window.login=()=>{
 signInWithEmailAndPassword(auth,email.value.trim(),pass.value)
 .then(()=>{
  loginCard.style.display="none";
  panel.style.display="block";

  const audio=document.getElementById("alertAudio");
  audio.play().then(()=>{
    audio.pause();
    audio.currentTime=0;
    audioAllowed=true;
  }).catch(()=>{});
 })
 .catch(e=>alert(e.message));
};

/* LOGOUT */
window.logout=()=>{
 signOut(auth).then(()=>{
  panel.style.display="none";
  loginCard.style.display="block";
 });
};

/* PRICE */
window.savePrice=()=>{
 set(ref(db,"settings/pricePerId"),Number(price.value));
};

/* ADD STOCK */
window.addIDs=()=>{
 const lines=ids.value.trim().split("\n");
 if(lines.length%4!==0) return;

 for(let i=0;i<lines.length;i+=4){
  push(ref(db,"stock"),{
   username:lines[i],
   password:lines[i+1],
   phone:lines[i+2],
   email:lines[i+3],
   sold:false
  });
 }
 ids.value="";
};

/* STOCK COUNT */
onValue(ref(db,"stock"),snap=>{
 let c=0;
 snap.forEach(s=>{ if(!s.val().sold) c++; });
 stock.innerText=c;
});

/* üîî PENDING ORDERS + CONTINUOUS BEEP */
onValue(ref(db,"orders"),snap=>{
 orders.innerHTML="";
 let pending=0;

 snap.forEach(o=>{
  const v=o.val();
  if(v.status==="pending"){
   pending++;

   const d=document.createElement("div");
   d.className="order";
   d.innerHTML=`
    <b>Order ID:</b> ${o.key}
    <b>Qty:</b> ${v.qty}
    <b>Amount:</b> ‚Çπ${v.amount}
    <b>UTR:</b> ${v.utr||"N/A"}
    <button class="verify" onclick="verify('${o.key}',${v.qty})">
     Verify & Deliver
    </button>
   `;
   orders.appendChild(d);
  }
 });

 const audio=document.getElementById("alertAudio");

 if(pending>0 && audioAllowed && !isBeeping){
  audio.currentTime=0;
  audio.play().catch(()=>{});
  isBeeping=true;
 }

 if(pending===0 && isBeeping){
  audio.pause();
  audio.currentTime=0;
  isBeeping=false;
 }
});

/* ‚úÖ VERIFY ‚Äì BUG FIXED */
window.verify=async(orderId,qty)=>{
 const orderRef=ref(db,"orders/"+orderId);
 const orderSnap=await get(orderRef);

 if(!orderSnap.exists()) return;
 if(orderSnap.val().status!=="pending") return;

 await update(orderRef,{status:"processing"});

 const stockSnap=await get(ref(db,"stock"));
 let selected=[];

 stockSnap.forEach(s=>{
  if(!s.val().sold && selected.length<qty){
   selected.push({id:s.key,...s.val()});
  }
 });

 if(selected.length<qty){
  await update(orderRef,{status:"pending"});
  alert("Not enough stock");
  return;
 }

 for(const item of selected){
  await update(ref(db,"stock/"+item.id),{sold:true});
  await push(ref(db,"deliveries/"+orderId),{
   username:item.username,
   password:item.password,
   phone:item.phone,
   email:item.email
  });
 }

 await update(orderRef,{status:"verified"});
 alert("‚úÖ "+qty+" ID delivered");
};
</script>
</body>
</html>
